import nmap

from PortScanning import OPENPROT
from myPool import MyPool


def scan_system(domain_name):
    """
    判断操作系统
    :param domain_name: 主机名或IP
    :return:
    """
    nm = nmap.PortScanner()  # 创建扫描对象
    os_list = []
    try:
        scan_result = nm.scan(hosts=domain_name, arguments='-O')  # 添加扫描参数
        print(scan_result)
        for i, j in scan_result['scan'].items():  # 将扫描结果转成字典
            if j['osmatch']:  # 判断是否有osmatch
                for k in j['osmatch']:
                    for os in k['osclass']:
                        # print(domain_name,os['osfamily'],'\n')
                        os_list.append(os['osfamily'])  # osfamily对应的是操作系统家族
            else:
                break
    except Exception as e:
        print(domain_name, 'None\n')  # 当链接不能被访问时，抛出异常
    if len(os_list) != 0:
        # print(os_list)
        return domain_name, max(os_list, key=os_list.count)
    return 0


def callback(msg):
    if msg != 0:
        print(msg)


if __name__ == "__main__":
    # openprot = OPENPROT()
    # url = ['192.168.0.160',
    # '192.168.0.170', '192.168.0.171', '192.168.0.172', '192.168.0.173', '192.168.0.174', '192.168.0.175', '192.168.0.176', '192.168.0.177', '192.168.0.178', '192.168.0.179', '192.168.0.180', '192.168.0.181', '192.168.0.182', '192.168.0.183', '192.168.0.184', '192.168.0.185', '192.168.0.186', '192.168.0.187', '192.168.0.188', '192.168.0.189', '192.168.0.190', '192.168.0.191', '192.168.0.192', '192.168.0.193', '192.168.0.194', '192.168.0.195', '192.168.0.196', '192.168.0.197', '192.168.0.198', '192.168.0.199', '192.168.0.200', '192.168.0.201', '192.168.0.202', '192.168.0.203', '192.168.0.204', '192.168.0.205', '192.168.0.206', '192.168.0.207', '192.168.0.208', '192.168.0.209', '192.168.0.210', '192.168.0.211', '192.168.0.212', '192.168.0.213', '192.168.0.214', '192.168.0.215', '192.168.0.216', '192.168.0.217', '192.168.0.218', '192.168.0.219', '192.168.0.220', '192.168.0.221', '192.168.0.222', '192.168.0.223', '192.168.0.224', '192.168.0.225', '192.168.0.226', '192.168.0.227', '192.168.0.228', '192.168.0.229', '192.168.0.230', '192.168.0.231', '192.168.0.232', '192.168.0.233', '192.168.0.234', '192.168.0.235', '192.168.0.236', '192.168.0.237', '192.168.0.238', '192.168.0.239', '192.168.0.240', '192.168.0.241', '192.168.0.242', '192.168.0.243', '192.168.0.244', '192.168.0.245', '192.168.0.246', '192.168.0.247', '192.168.0.248', '192.168.0.249', '192.168.0.250', '192.168.0.251', '192.168.0.252', '192.168.0.253', '192.168.0.254']
    # myPool = MyPool(8, False)
    # myPool.run(scan_system, url, callback)
    # myPool.start()
    print(scan_system('192.168.0.1'))
    # for i in range(len(url)):
    #     print(i)
    #     scan_system(url[i])
